---
import Layout from "../layouts/Layout.astro";
import CartList from "../features/cart/components/CartList.astro";
---

<Layout title="Tu Carrito de Compras">
  <main class="container mx-auto p-4 md:p-8 space-y-8">
    <div
      id="cart-container"
      class="flex flex-col lg:flex-row gap-8 items-start"
    >
      <CartList />

      <aside
        class="w-full lg:w-1/3 p-6 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-md space-y-4 sticky top-4"
      >
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
          Resumen del Pedido
        </h2>
        <div class="space-y-2">
          <div
            class="flex justify-between font-bold text-gray-900 dark:text-white"
          >
            <span>Total:</span>
            <span id="total-price">$0.00</span>
          </div>
        </div>
        <a
          id="checkout-button"
          href="/client/pago"
          class="block text-center w-full py-3 px-4 text-white bg-lime-600 rounded-lg hover:bg-lime-700 transition-colors"
        >
          Proceder al Pago
        </a>
        <p
          id="checkout-disabled-message"
          class="text-center text-sm text-gray-500"
        >
          Agrega productos para proceder al pago.
        </p>
      </aside>
    </div>
  </main>
</Layout>

<script>
  // @ts-nocheck
  import { cart } from "../features/cart/components/cart.module.js";

  const totalPriceEl = document.querySelector("#total-price");
  const checkoutButton = document.querySelector("#checkout-button");
  const disabledMessage = document.querySelector("#checkout-disabled-message");

  const updateTotal = (cartItems) => {
    // Calculamos el total
    const total = cartItems.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    );

    // Actualizamos el texto del total
    totalPriceEl.textContent = `$${total.toFixed(2)}`;

    // Guardamos el total en localStorage para usarlo en la página de pago
    localStorage.setItem("cartTotal", total.toFixed(2));

    // Habilitamos o deshabilitamos el botón de pago
    if (cartItems.length > 0) {
      checkoutButton.style.display = "block";
      disabledMessage.style.display = "none";
    } else {
      checkoutButton.style.display = "none";
      disabledMessage.style.display = "block";
    }
  };

  // Nos suscribimos a los cambios del carrito para mantener el total actualizado
  cart.subscribe(updateTotal);

  // Llamamos una vez al inicio para establecer el estado inicial
  updateTotal(cart.get());
</script>
